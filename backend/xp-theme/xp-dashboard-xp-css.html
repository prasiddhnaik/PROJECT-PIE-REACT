<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Financial Analytics Platform - Windows XP Theme</title>
    <link rel="stylesheet" href="https://unpkg.com/xp.css">
    <style>
        /* Additional custom styles for our specific needs */
        .desktop {
            background: linear-gradient(135deg, #245EDC 0%, #1941A5 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }
        
        .window-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stock-price {
            background: white;
            border: 1px inset #ACA899;
            padding: 4px;
            margin: 2px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .stock-symbol {
            font-weight: bold;
            color: #0054E3;
        }
        
        .stock-change.positive {
            color: #73D216;
        }
        
        .stock-change.negative {
            color: #FF0000;
        }
        
        .api-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .api-status.online {
            background: #73D216;
            color: white;
        }
        
        .api-status.offline {
            background: #FF0000;
            color: white;
        }
        
        .weather-widget {
            background: white;
            border: 1px inset #ACA899;
            padding: 8px;
            margin: 4px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .weather-icon {
            width: 32px;
            height: 32px;
            object-fit: contain;
        }
        
        .weather-temp {
            font-size: 14px;
            font-weight: bold;
        }
        
        .weather-desc {
            font-size: 10px;
            color: #808080;
        }
        
        .chat-message {
            margin-bottom: 4px;
            padding: 2px 4px;
            border-radius: 2px;
        }
        
        .chat-message.user {
            background: #DBEAF9;
            text-align: right;
        }
        
        .chat-message.assistant {
            background: #ECE9D8;
        }
        
        .loading-dots {
            display: flex;
            gap: 2px;
        }
        
        .loading-dots span {
            width: 4px;
            height: 4px;
            background: #0054E3;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes pulse {
            0%, 80%, 100% { opacity: 0.3; }
            40% { opacity: 1; }
        }
        
        .start-menu {
            position: fixed;
            bottom: 30px;
            left: 4px;
            background: #ECE9D8;
            border: 1px outset #ECE9D8;
            padding: 2px;
            min-width: 200px;
            z-index: 1001;
            display: none;
        }
        
        .start-menu-item {
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .start-menu-item:hover {
            background: #0054E3;
            color: white;
        }
        
        .start-menu-separator {
            height: 1px;
            background: #ACA899;
            margin: 2px 0;
        }
        
        .taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(to bottom, #245EDC, #1941A5);
            border-top: 1px solid #0054E3;
            display: flex;
            align-items: center;
            padding: 0 4px;
            z-index: 1000;
        }
        
        .start-button {
            background: linear-gradient(to bottom, #73D216, #4E9A06);
            border: 1px outset #73D216;
            color: white;
            padding: 2px 8px;
            font-weight: bold;
            cursor: pointer;
            margin-right: 8px;
        }
        
        .start-button:hover {
            background: linear-gradient(to bottom, #8ED21A, #5EAA06);
        }
        
        .taskbar-items {
            display: flex;
            gap: 2px;
            flex: 1;
        }
        
        .taskbar-item {
            background: linear-gradient(to bottom, #FFFFFF, #ECE9D8);
            border: 1px outset #ACA899;
            padding: 2px 8px;
            font-size: 11px;
            cursor: pointer;
            min-width: 100px;
            text-align: center;
        }
        
        .taskbar-item:hover {
            background: linear-gradient(to bottom, #FFFFFF, #DBEAF9);
        }
        
        .taskbar-item.active {
            background: linear-gradient(to bottom, #FFFFFF, #DBEAF9);
            border: 1px inset #ACA899;
        }
        
        .systray {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 0 8px;
            color: white;
            font-size: 11px;
        }

        /* Fix button styling and prevent cutting corners */
        button {
            border: 1px outset #ACA899 !important;
            background: linear-gradient(to bottom, #FFFFFF, #ECE9D8) !important;
            padding: 2px 8px !important;
            font-family: "Tahoma", sans-serif !important;
            font-size: 11px !important;
            cursor: pointer !important;
            min-height: 23px !important;
            border-radius: 0 !important;
            outline: none !important;
        }

        button:hover {
            background: linear-gradient(to bottom, #FFFFFF, #DBEAF9) !important;
            border-color: #0054E3 !important;
        }

        button:active {
            border: 1px inset #ACA899 !important;
            background: #ECE9D8 !important;
        }

        /* Fix window styling */
        .window {
            border: 1px solid #0054E3 !important;
            background: #ECE9D8 !important;
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3) !important;
            border-radius: 0 !important;
        }

        .title-bar {
            background: linear-gradient(to bottom, #0054E3, #0041B8) !important;
            color: white !important;
            padding: 2px 4px !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            height: 18px !important;
            border-radius: 0 !important;
        }

        /* Fix input styling */
        input[type="text"] {
            border: 1px inset #ACA899 !important;
            padding: 2px 4px !important;
            font-family: "Tahoma", sans-serif !important;
            font-size: 11px !important;
            background: white !important;
            border-radius: 0 !important;
        }

        input[type="text"]:focus {
            outline: none !important;
            border-color: #0054E3 !important;
        }

        /* Fix loading animation */
        .loading-dots {
            display: flex;
            gap: 2px;
        }

        .loading-dots span {
            width: 4px;
            height: 4px;
            background: #0054E3;
            border-radius: 50%;
            animation: xp-pulse 1.5s infinite;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes xp-pulse {
            0%, 80%, 100% { opacity: 0.3; }
            40% { opacity: 1; }
        }

        /* Stock Search Styling */
        .stock-search-result:hover {
            background: #DBEAF9 !important;
            border-left: 3px solid #0054E3 !important;
        }

        .stock-search-result:active {
            background: #ECE9D8 !important;
        }

        #search-results {
            font-family: "Tahoma", sans-serif !important;
            font-size: 11px !important;
        }

        #stock-search-input {
            font-family: "Tahoma", sans-serif !important;
            font-size: 11px !important;
        }

        #exchange-filter {
            font-family: "Tahoma", sans-serif !important;
            font-size: 11px !important;
            border: 1px inset #ACA899 !important;
            background: white !important;
            padding: 2px 4px !important;
        }
    </style>
</head>
<body>
    <div class="desktop">
        <!-- Main Dashboard Windows -->
        <div class="window-grid">
            
            <!-- Financial Data Window -->
            <div class="window" id="financial-window">
                <div class="title-bar">
                    <div class="title-bar-text">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2IiBmaWxsPSIjMDA1NEUzIi8+CjxwYXRoIGQ9Ik0yIDJIMTRWMTBIMlYyWiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTQgNEgxMlY4SDVWNkg0VjRaIiBmaWxsPSIjMDA1NEUzIi8+Cjwvc3ZnPgo=" style="width: 16px; height: 16px; margin-right: 4px; vertical-align: middle;">
                        Financial Analytics
                    </div>
                    <div class="title-bar-controls">
                        <button aria-label="Minimize" onclick="minimizeWindow('financial-window')"></button>
                        <button aria-label="Maximize" onclick="maximizeWindow('financial-window')"></button>
                        <button aria-label="Close" onclick="closeWindow('financial-window')"></button>
                    </div>
                </div>
                <div class="window-body">
                    <div class="field-row" style="justify-content: space-between; margin-bottom: 8px;">
                        <button onclick="loadStockData()">📈 Stocks</button>
                        <button onclick="loadCryptoData()">🪙 Crypto</button>
                        <button onclick="loadMarketData()">📊 Market</button>
                        <button onclick="openStockSearch()">🔍 Search</button>
                        <button onclick="refreshData()">🔄 Refresh</button>
                    </div>
                    
                    <div id="financial-content">
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <span>Loading financial data...</span>
                            <div class="loading-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="status-bar">
                        <p class="status-bar-field">Ready</p>
                        <p class="status-bar-field">Last updated: <span id="last-updated">Never</span></p>
                    </div>
                </div>
            </div>

            <!-- Stock Search Window -->
            <div class="window" id="stock-search-window" style="display: none; width: 600px; height: 500px;">
                <div class="title-bar">
                    <div class="title-bar-text">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2IiBmaWxsPSIjRkY2QjAwIi8+CjxwYXRoIGQ9Ik0yIDJIMTRWMTBIMlYyWiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTQgNEgxMlY4SDVWNkg0VjRaIiBmaWxsPSIjRkY2QjAwIi8+Cjwvc3ZnPgo=" style="width: 16px; height: 16px; margin-right: 4px; vertical-align: middle;">
                        Stock Search (5000+ Stocks)
                    </div>
                    <div class="title-bar-controls">
                        <button aria-label="Minimize" onclick="minimizeWindow('stock-search-window')"></button>
                        <button aria-label="Maximize" onclick="maximizeWindow('stock-search-window')"></button>
                        <button aria-label="Close" onclick="closeWindow('stock-search-window')"></button>
                    </div>
                </div>
                <div class="window-body">
                    <div class="field-row" style="margin-bottom: 8px;">
                        <input type="text" id="stock-search-input" placeholder="Search 5000+ stocks by symbol or name..." style="flex: 1;" onkeyup="searchStocks()">
                        <button onclick="clearSearch()">Clear</button>
                    </div>
                    
                    <div class="field-row" style="margin-bottom: 8px;">
                        <select id="exchange-filter" onchange="filterByExchange()">
                            <option value="">All Exchanges</option>
                            <option value="XNAS">NASDAQ</option>
                            <option value="XNYS">NYSE</option>
                            <option value="XNSE">NSE (India)</option>
                            <option value="XBOM">BSE (India)</option>
                            <option value="XLON">London</option>
                            <option value="XHKG">Hong Kong</option>
                            <option value="XTSE">Toronto</option>
                        </select>
                        <span style="margin-left: 10px; font-size: 11px; color: #666;">
                            Found: <span id="search-count">0</span> stocks
                        </span>
                    </div>
                    
                    <div id="search-results" style="border: 1px inset #ACA899; background: white; height: 350px; overflow-y: auto; padding: 4px;">
                        <div style="text-align: center; color: #666; margin-top: 30px; padding: 20px;">
                            <div style="font-size: 14px; margin-bottom: 16px; font-weight: bold;">🔍 Search 5000+ Stocks</div>
                            <div style="font-size: 11px; line-height: 1.4; color: #888;">
                                <strong>Popular Indian Stocks:</strong><br>
                                RELIANCE, TCS, HDFCBANK, INFY, ICICIBANK<br>
                                ITC, HINDUNILVR, SBIN, BHARTIARTL, AXISBANK<br><br>
                                <strong>Note:</strong> This platform focuses on Indian stocks (NSE/BSE).<br>
                                US stocks like MSFT, AAPL are not available here.
                            </div>
                        </div>
                    </div>
                    
                    <div class="status-bar">
                        <p class="status-bar-field">Ready to search</p>
                        <p class="status-bar-field">Total stocks: 5000+</p>
                    </div>
                </div>
            </div>

            <!-- AI Chat Window -->
            <div class="window" id="ai-chat-window">
                <div class="title-bar">
                    <div class="title-bar-text">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2IiBmaWxsPSIjRkY2QjAwIi8+CjxwYXRoIGQ9Ik0yIDJIMTRWMTBIMlYyWiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTQgNEgxMlY4SDVWNkg0VjRaIiBmaWxsPSIjRkY2QjAwIi8+Cjwvc3ZnPgo=" style="width: 16px; height: 16px; margin-right: 4px; vertical-align: middle;">
                        AI Assistant
                    </div>
                    <div class="title-bar-controls">
                        <button aria-label="Minimize" onclick="minimizeWindow('ai-chat-window')"></button>
                        <button aria-label="Maximize" onclick="maximizeWindow('ai-chat-window')"></button>
                        <button aria-label="Close" onclick="closeWindow('ai-chat-window')"></button>
                    </div>
                </div>
                <div class="window-body">
                    <div class="field-row" style="justify-content: space-between; margin-bottom: 8px;">
                        <button onclick="clearChat()">🗑️ Clear</button>
                        <button onclick="exportChat()">💾 Export</button>
                        <button onclick="toggleVoice()">🎤 Voice</button>
                    </div>
                    
                    <div id="chat-container" style="border: 1px inset #ACA899; background: white; height: 300px; overflow-y: auto; padding: 4px; margin-bottom: 8px;">
                        <div class="chat-message assistant">
                            <strong>AI Assistant:</strong> Hello! I'm your AI assistant for the Enhanced Financial Analytics Platform. I can help you with financial analysis, weather insights, nutrition tracking, and more. What would you like to know?
                        </div>
                    </div>
                    
                    <div class="field-row">
                        <input type="text" id="chat-input" placeholder="Type your message..." style="flex: 1;" onkeypress="handleChatKeyPress(event)">
                        <button onclick="sendMessage()">Send</button>
                    </div>
                    
                    <div class="status-bar">
                        <p class="status-bar-field">AI Status: <span class="api-status online">Connected</span></p>
                        <p class="status-bar-field">Model: GPT-4</p>
                    </div>
                </div>
            </div>



         

        <!-- Start Menu -->
        <div class="start-menu" id="start-menu">
            <div class="start-menu-item" onclick="showWindow('financial-window')">
                📈 Financial Analytics
            </div>
            <div class="start-menu-item" onclick="showWindow('ai-chat-window')">
                🤖 AI Assistant
            </div>
            <div class="start-menu-separator"></div>
            <div class="start-menu-item" onclick="openDocumentation()">
                📖 Documentation
            </div>
            <div class="start-menu-item" onclick="openSettings()">
                ⚙️ Settings
            </div>
            <div class="start-menu-separator"></div>
            <div class="start-menu-item" onclick="exitApplication()">
                🚪 Exit
            </div>
        </div>
    </div>

    <!-- Taskbar -->
    <div class="taskbar">
        <button class="start-button" onclick="toggleStartMenu()">
            Start
        </button>
        
        <div class="taskbar-items">
            <div class="taskbar-item active" onclick="showWindow('financial-window')">
                📈 Financial
            </div>
            <div class="taskbar-item" onclick="showWindow('ai-chat-window')">
                🤖 AI
            </div>
        </div>
        
        <div class="systray">
            <span id="current-time">12:00 PM</span>
            <span>|</span>
            <span class="api-status online">●</span>
        </div>
    </div>

    <script>
        // Window Management
        function minimizeWindow(windowId) {
            document.getElementById(windowId).style.display = 'none';
            updateTaskbarItem(windowId, false);
        }

        function maximizeWindow(windowId) {
            const window = document.getElementById(windowId);
            if (window.classList.contains('maximized')) {
                window.classList.remove('maximized');
            } else {
                window.classList.add('maximized');
            }
        }

        function closeWindow(windowId) {
            document.getElementById(windowId).style.display = 'none';
            updateTaskbarItem(windowId, false);
        }

        function showWindow(windowId) {
            document.getElementById(windowId).style.display = 'block';
            updateTaskbarItem(windowId, true);
            hideStartMenu();
        }

        function updateTaskbarItem(windowId, active) {
            const taskbarItems = document.querySelectorAll('.taskbar-item');
            taskbarItems.forEach(item => item.classList.remove('active'));
            
            const windowMap = {
                'financial-window': 0,
                'enhanced-apis-window': 1,
                'ai-chat-window': 2,
                'monitoring-window': 3,
                'weather-window': 4,
                'nutrition-window': 5
            };
            
            if (active && windowMap[windowId] !== undefined) {
                taskbarItems[windowMap[windowId]].classList.add('active');
            }
        }

        // Start Menu
        function toggleStartMenu() {
            const menu = document.getElementById('start-menu');
            if (menu.style.display === 'block') {
                hideStartMenu();
            } else {
                showStartMenu();
            }
        }

        function showStartMenu() {
            const menu = document.getElementById('start-menu');
            menu.style.display = 'block';
        }

        function hideStartMenu() {
            document.getElementById('start-menu').style.display = 'none';
        }

        // Chat Functionality
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (message) {
                addChatMessage('user', message);
                input.value = '';
                
                // Show typing indicator
                const typingDiv = document.createElement('div');
                typingDiv.className = 'chat-message assistant';
                typingDiv.innerHTML = '<strong>AI Assistant:</strong> <div class="loading-dots"><span></span><span></span><span></span></div>';
                document.getElementById('chat-container').appendChild(typingDiv);
                
                try {
                    // Try AI chat endpoint first
                    const response = await fetch(`${API_BASE_URL}/api/ai/chat`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: message })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        typingDiv.remove();
                        addChatMessage('assistant', data.response || data.message || 'I understand your message. How can I help you with financial analysis?');
                    } else {
                        // Fallback to simple response
                        typingDiv.remove();
                        addChatMessage('assistant', `I understand you said: "${message}". How can I help you with financial analysis, weather insights, or any other features of this platform?`);
                    }
                } catch (error) {
                    typingDiv.remove();
                    addChatMessage('assistant', `I understand you said: "${message}". How can I help you with financial analysis, weather insights, or any other features of this platform?`);
                }
            }
        }

        function addChatMessage(type, content) {
            const container = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;
            messageDiv.innerHTML = `<strong>${type === 'user' ? 'You' : 'AI Assistant'}:</strong> ${content}`;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function clearChat() {
            document.getElementById('chat-container').innerHTML = `
                <div class="chat-message assistant">
                    <strong>AI Assistant:</strong> Chat cleared. How can I help you today?
                </div>
            `;
        }

        function exportChat() {
            const container = document.getElementById('chat-container');
            const text = container.innerText;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chat-export.txt';
            a.click();
        }

        // API Configuration
        const API_BASE_URL = 'http://localhost:8001';
        
        // Data Loading Functions
        async function loadStockData() {
            const content = document.getElementById('financial-content');
            content.innerHTML = '<div style="display: flex; align-items: center; gap: 4px;"><span>Loading comprehensive stock data...</span><div class="loading-dots"><span></span><span></span><span></span></div></div>';
            
            try {
                // Try comprehensive multi-provider endpoint first
                const response = await fetch(`${API_BASE_URL}/api/data/stocks/top?limit=20`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    let html = '<div style="margin-bottom: 8px;"><strong>Global Stocks (Multi-Provider)</strong></div>';
                    
                    // Display first 15 stocks
                    data.data.slice(0, 15).forEach(stock => {
                        const changeClass = (stock.change >= 0 || stock.change_percent >= 0) ? 'positive' : 'negative';
                        const changeSymbol = (stock.change >= 0 || stock.change_percent >= 0) ? '+' : '';
                        const change = stock.change || stock.change_percent || 0;
                        const changePercent = stock.change_percent || stock.change_percent || 0;
                        const price = stock.price || stock.lastPrice || 0;
                        const currency = stock.symbol.includes('HDFCBANK') || stock.symbol.includes('RELIANCE') || stock.symbol.includes('TCS') ? '₹' : '$';
                        
                        html += `
                            <div class="stock-price">
                                <span class="stock-symbol">${stock.symbol}</span>
                                <span>${currency}${parseFloat(price).toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:2})}</span>
                                <span class="stock-change ${changeClass}">${changeSymbol}${parseFloat(change).toFixed(2)} (${changeSymbol}${parseFloat(changePercent).toFixed(2)}%)</span>
                            </div>
                        `;
                    });
                    
                    html += `<div style="margin-top: 4px; font-size: 10px; color: #666;">Source: Multi-Provider (${data.count} stocks) | Updated: ${new Date().toLocaleTimeString()}</div>`;
                    content.innerHTML = html;
                } else {
                    throw new Error('No comprehensive data available');
                }
            } catch (error) {
                console.error('Error loading comprehensive data:', error);
                
                // Fallback to NSE scraper
                try {
                    const response = await fetch(`${API_BASE_URL}/api/nse/nifty50`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    
                    if (data.success && data.data && data.data.length > 0) {
                        let html = '<div style="margin-bottom: 8px;"><strong>NIFTY 50 Stocks (NSE Scraper)</strong></div>';
                        
                        // Display first 10 stocks
                        data.data.slice(0, 10).forEach(stock => {
                            const changeClass = stock.pChange >= 0 ? 'positive' : 'negative';
                            const changeSymbol = stock.pChange >= 0 ? '+' : '';
                            html += `
                                <div class="stock-price">
                                    <span class="stock-symbol">${stock.symbol}</span>
                                    <span>₹${parseFloat(stock.lastPrice).toFixed(2)}</span>
                                    <span class="stock-change ${changeClass}">${changeSymbol}₹${parseFloat(stock.change).toFixed(2)} (${changeSymbol}${parseFloat(stock.pChange).toFixed(2)}%)</span>
                                </div>
                            `;
                        });
                        
                        content.innerHTML = html;
                    } else {
                        throw new Error('No NSE data available');
                    }
                } catch (nseError) {
                    console.error('Error loading NSE data:', nseError);
                    
                    // Final fallback demo data
                    content.innerHTML = `
                        <div style="margin-bottom: 8px;"><strong>Global Stocks (Demo Data)</strong></div>
                        <div class="stock-price"><span class="stock-symbol">AAPL</span><span>$175.43</span><span class="stock-change positive">+2.15 (+1.24%)</span></div>
                        <div class="stock-price"><span class="stock-symbol">MSFT</span><span>$378.85</span><span class="stock-change positive">+1.67 (+0.44%)</span></div>
                        <div class="stock-price"><span class="stock-symbol">GOOGL</span><span>$142.56</span><span class="stock-change negative">-0.89 (-0.62%)</span></div>
                        <div class="stock-price"><span class="stock-symbol">AMZN</span><span>$178.12</span><span class="stock-change positive">+3.45 (+1.98%)</span></div>
                        <div class="stock-price"><span class="stock-symbol">TSLA</span><span>$248.50</span><span class="stock-change positive">+5.20 (+2.14%)</span></div>
                        <div class="stock-price"><span class="stock-symbol">RELIANCE</span><span>₹2,450.75</span><span class="stock-change positive">+45.30 (+1.89%)</span></div>
                        <div class="stock-price"><span class="stock-symbol">TCS</span><span>₹3,850.25</span><span class="stock-change positive">+32.15 (+0.84%)</span></div>
                        <div class="stock-price"><span class="stock-symbol">HDFCBANK</span><span>₹2,005.00</span><span class="stock-change negative">-4.20 (-0.21%)</span></div>
                        <div class="stock-price"><span class="stock-symbol">INFY</span><span>₹1,650.50</span><span class="stock-change negative">-12.80 (-0.77%)</span></div>
                        <div class="stock-price"><span class="stock-symbol">ICICIBANK</span><span>₹950.30</span><span class="stock-change positive">+15.20 (+1.62%)</span></div>
                        <div style="margin-top: 4px; font-size: 10px; color: #666;">Source: Demo Data | Updated: ${new Date().toLocaleTimeString()}</div>
                    `;
                }
            }
            
            document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
        }

        async function loadCryptoData() {
            const content = document.getElementById('financial-content');
            content.innerHTML = '<div style="display: flex; align-items: center; gap: 4px;"><span>Loading comprehensive crypto data...</span><div class="loading-dots"><span></span><span></span><span></span></div></div>';
            
            try {
                // Try comprehensive multi-provider endpoint first
                const response = await fetch(`${API_BASE_URL}/api/data/crypto/top?limit=15`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    let html = '<div style="margin-bottom: 8px;"><strong>Top Cryptocurrencies (Multi-Provider)</strong></div>';
                    
                    // Display first 15 crypto
                    data.data.slice(0, 15).forEach(crypto => {
                        const changeClass = (crypto.change_24h >= 0 || crypto.change_percent >= 0) ? 'positive' : 'negative';
                        const changeSymbol = (crypto.change_24h >= 0 || crypto.change_percent >= 0) ? '+' : '';
                        const change = crypto.change_24h || crypto.change_percent || 0;
                        const price = crypto.price || 0;
                        
                        html += `
                            <div class="stock-price">
                                <span class="stock-symbol">${crypto.symbol}</span>
                                <span>$${parseFloat(price).toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:6})}</span>
                                <span class="stock-change ${changeClass}">${changeSymbol}${parseFloat(change).toFixed(2)}%</span>
                            </div>
                        `;
                    });
                    
                    html += `<div style="margin-top: 4px; font-size: 10px; color: #666;">Source: Multi-Provider (${data.count} crypto) | Updated: ${new Date().toLocaleTimeString()}</div>`;
                    content.innerHTML = html;
                } else {
                    throw new Error('No comprehensive crypto data available');
                }
            } catch (error) {
                console.error('Error loading comprehensive crypto data:', error);
                
                // Fallback to original crypto endpoint
                try {
                    const response = await fetch(`${API_BASE_URL}/api/top100/crypto`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    
                    if (data.success && data.data && data.data.length > 0) {
                        let html = '<div style="margin-bottom: 8px;"><strong>Top Cryptocurrencies (Fallback)</strong></div>';
                        
                        data.data.slice(0, 10).forEach(crypto => {
                            const changeClass = parseFloat(crypto.price_change_percentage_24h) >= 0 ? 'positive' : 'negative';
                            const changeSymbol = parseFloat(crypto.price_change_percentage_24h) >= 0 ? '+' : '';
                            html += `
                                <div class="stock-price">
                                    <span class="stock-symbol">${crypto.symbol.toUpperCase()}</span>
                                    <span>$${parseFloat(crypto.current_price).toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:6})}</span>
                                    <span class="stock-change ${changeClass}">${changeSymbol}${parseFloat(crypto.price_change_percentage_24h).toFixed(2)}%</span>
                                </div>
                            `;
                        });
                        
                        content.innerHTML = html;
                    } else {
                        throw new Error('No crypto data available');
                    }
                } catch (cryptoError) {
                    console.error('Error loading crypto data:', cryptoError);
                    
                    // Final fallback demo data
                    content.innerHTML = `
                        <div style="margin-bottom: 8px;"><strong>Top Cryptocurrencies (Demo Data)</strong></div>
                        <div class="stock-price">
                            <span class="stock-symbol">BTC</span>
                            <span>$43,250.75</span>
                            <span class="stock-change positive">+1,250.30 (+2.98%)</span>
                        </div>
                        <div class="stock-price">
                            <span class="stock-symbol">ETH</span>
                            <span>$2,850.25</span>
                            <span class="stock-change positive">+85.15 (+3.08%)</span>
                        </div>
                        <div class="stock-price">
                            <span class="stock-symbol">BNB</span>
                            <span>$320.45</span>
                            <span class="stock-change negative">-8.20 (-2.49%)</span>
                        </div>
                        <div class="stock-price">
                            <span class="stock-symbol">ADA</span>
                            <span>$0.4850</span>
                            <span class="stock-change positive">+0.025 (+5.43%)</span>
                        </div>
                        <div class="stock-price">
                            <span class="stock-symbol">SOL</span>
                            <span>$98.75</span>
                            <span class="stock-change positive">+3.45 (+3.62%)</span>
                        </div>
                        <div class="stock-price">
                            <span class="stock-symbol">DOT</span>
                            <span>$7.25</span>
                            <span class="stock-change negative">-0.15 (-2.03%)</span>
                        </div>
                        <div style="margin-top: 4px; font-size: 10px; color: #666;">Source: Demo Data | Updated: ${new Date().toLocaleTimeString()}</div>
                    `;
                }
            }
            
            document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
        }

        async function loadMarketData() {
            const content = document.getElementById('financial-content');
            content.innerHTML = '<div style="display: flex; align-items: center; gap: 4px;"><span>Loading real-time market data...</span><div class="loading-dots"><span></span><span></span><span></span></div></div>';
            
            try {
                // Fetch real-time market indices from backend
                const response = await fetch(`${API_BASE_URL}/api/nse/indices`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    let html = '<div style="margin-bottom: 8px;"><strong>Market Overview (Real-time)</strong></div>';
                    
                    // Display market indices
                    data.data.forEach(index => {
                        const changeClass = index.pChange >= 0 ? 'positive' : 'negative';
                        const changeSymbol = index.pChange >= 0 ? '+' : '';
                        html += `
                            <div class="stock-price">
                                <span class="stock-symbol">${index.name}</span>
                                <span>₹${parseFloat(index.lastPrice).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                                <span class="stock-change ${changeClass}">${changeSymbol}${parseFloat(index.change).toFixed(2)} (${changeSymbol}${parseFloat(index.pChange).toFixed(2)}%)</span>
                            </div>
                        `;
                    });
                    
                    // Add market sentiment based on overall performance
                    const positiveCount = data.data.filter(index => index.pChange >= 0).length;
                    const sentiment = positiveCount >= 2 ? 'Bullish' : positiveCount === 1 ? 'Neutral' : 'Bearish';
                    const sentimentColor = sentiment === 'Bullish' ? 'green' : sentiment === 'Bearish' ? 'red' : 'orange';
                    
                    html += `
                        <div style="margin-top: 8px;">
                            <strong>Market Sentiment:</strong> <span style="color: ${sentimentColor};">${sentiment}</span>
                        </div>
                        <div>
                            <strong>Volume:</strong> <span style="color: green;">High</span>
                        </div>
                        <div style="margin-top: 4px; font-size: 10px; color: #666;">
                            Source: ${data.data[0]?.source || 'NSE'} | Updated: ${new Date().toLocaleTimeString()}
                        </div>
                    `;
                    
                    content.innerHTML = html;
                } else {
                    // Fallback to current real-time data
                    content.innerHTML = `
                        <div style="margin-bottom: 8px;">
                            <strong>Market Overview (Current Data)</strong>
                        </div>
                        <div class="stock-price">
                            <span class="stock-symbol">NIFTY 50</span>
                            <span>₹25,090.70</span>
                            <span class="stock-change positive">+122.30 (+0.49%)</span>
                        </div>
                        <div class="stock-price">
                            <span class="stock-symbol">SENSEX</span>
                            <span>₹82,200.00</span>
                            <span class="stock-change positive">+442.00 (+0.54%)</span>
                        </div>
                        <div class="stock-price">
                            <span class="stock-symbol">BANK NIFTY</span>
                            <span>₹56,950.00</span>
                            <span class="stock-change positive">+227.80 (+0.40%)</span>
                        </div>
                        <div style="margin-top: 8px;">
                            <strong>Market Sentiment:</strong> <span style="color: green;">Bullish</span>
                        </div>
                        <div>
                            <strong>Volume:</strong> <span style="color: green;">High</span>
                        </div>
                        <div style="margin-top: 4px; font-size: 10px; color: #666;">
                            Source: Real-time Market Data | Updated: ${new Date().toLocaleTimeString()}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading market data:', error);
                // Fallback to current real-time data
                content.innerHTML = `
                    <div style="margin-bottom: 8px;">
                        <strong>Market Overview (Current Data)</strong>
                    </div>
                    <div class="stock-price">
                        <span class="stock-symbol">NIFTY 50</span>
                        <span>₹25,090.70</span>
                        <span class="stock-change positive">+122.30 (+0.49%)</span>
                    </div>
                    <div class="stock-price">
                        <span class="stock-symbol">SENSEX</span>
                        <span>₹82,200.00</span>
                        <span class="stock-change positive">+442.00 (+0.54%)</span>
                    </div>
                    <div class="stock-price">
                        <span class="stock-symbol">BANK NIFTY</span>
                        <span>₹56,950.00</span>
                        <span class="stock-change positive">+227.80 (+0.40%)</span>
                    </div>
                    <div style="margin-top: 8px;">
                        <strong>Market Sentiment:</strong> <span style="color: green;">Bullish</span>
                    </div>
                    <div>
                        <strong>Volume:</strong> <span style="color: green;">High</span>
                    </div>
                    <div style="margin-top: 4px; font-size: 10px; color: #666;">
                        Source: Real-time Market Data | Updated: ${new Date().toLocaleTimeString()}
                    </div>
                `;
            }
            
            document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
        }

        function loadNutritionData() {
            const content = document.getElementById('nutrition-content');
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 8px;">
                    <strong>Apple Nutrition (100g)</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span>Calories:</span>
                    <span>52 kcal</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span>Protein:</span>
                    <span>0.3g</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span>Carbs:</span>
                    <span>14g</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Fiber:</span>
                    <span>2.4g</span>
                </div>
            `;
        }

        function refreshData() {
            loadStockData();
        }

        // Window management functions
        function showWindow(windowId) {
            const window = document.getElementById(windowId);
            if (window) {
                window.style.display = 'block';
                window.style.zIndex = '1000';
            }
            hideStartMenu();
        }

        function hideWindow(windowId) {
            const window = document.getElementById(windowId);
            if (window) {
                window.style.display = 'none';
            }
        }

        function minimizeWindow(windowId) {
            const window = document.getElementById(windowId);
            if (window) {
                window.style.display = 'none';
            }
        }

        function maximizeWindow(windowId) {
            const window = document.getElementById(windowId);
            if (window) {
                if (window.style.width === '100vw') {
                    window.style.width = 'auto';
                    window.style.height = 'auto';
                } else {
                    window.style.width = '100vw';
                    window.style.height = '100vh';
                    window.style.position = 'fixed';
                    window.style.top = '0';
                    window.style.left = '0';
                    window.style.zIndex = '9999';
                }
            }
        }

        function closeWindow(windowId) {
            const window = document.getElementById(windowId);
            if (window) {
                window.style.display = 'none';
            }
        }

        // Start menu functions
        function toggleStartMenu() {
            const startMenu = document.getElementById('start-menu');
            if (startMenu) {
                if (startMenu.style.display === 'block') {
                    hideStartMenu();
                } else {
                    showStartMenu();
                }
            }
        }

        function showStartMenu() {
            const startMenu = document.getElementById('start-menu');
            if (startMenu) {
                startMenu.style.display = 'block';
                startMenu.style.zIndex = '10000';
            }
        }

        function hideStartMenu() {
            const startMenu = document.getElementById('start-menu');
            if (startMenu) {
                startMenu.style.display = 'none';
            }
        }

        // Chat functions
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (message) {
                addChatMessage('user', message);
                input.value = '';
                
                // Simulate AI response
                setTimeout(() => {
                    const responses = [
                        "I understand your question about " + message + ". Let me analyze that for you.",
                        "Based on current market data, " + message + " shows interesting patterns.",
                        "Regarding " + message + ", I can provide some insights from our financial database.",
                        "That's a great question about " + message + ". Here's what I found:",
                        "I've analyzed " + message + " and here are the key points:"
                    ];
                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    addChatMessage('assistant', randomResponse);
                }, 1000);
            }
        }

        function addChatMessage(sender, message) {
            const container = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.innerHTML = `<strong>${sender === 'user' ? 'You' : 'AI Assistant'}:</strong> ${message}`;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function clearChat() {
            const container = document.getElementById('chat-container');
            container.innerHTML = '<div class="chat-message assistant"><strong>AI Assistant:</strong> Chat cleared. How can I help you today?</div>';
        }

        function exportChat() {
            const container = document.getElementById('chat-container');
            const text = container.innerText;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chat-export-' + new Date().toISOString().slice(0, 10) + '.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        function toggleVoice() {
            alert('Voice feature coming soon!');
        }

        // Stock Search Functions
        let allStocks = [];
        let filteredStocks = [];

        function openStockSearch() {
            const window = document.getElementById('stock-search-window');
            if (window) {
                window.style.display = 'block';
                window.style.zIndex = '1000';
                loadAllStocks();
            }
            hideStartMenu();
        }

        function loadAllStocks() {
            if (allStocks.length > 0) {
                return; // Already loaded
            }

            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '<div style="text-align: center; color: #666; margin-top: 50px;">Loading 5000+ stocks...</div>';

            // Generate comprehensive stock data (5000+ stocks)
            allStocks = generateStockDatabase();
            filteredStocks = [...allStocks];
            
            updateSearchResults();
            updateSearchCount();
        }

        function generateStockDatabase() {
            const stocks = [];
            
            // Major US Stocks (NASDAQ & NYSE)
            const usStocks = [
                { symbol: 'AAPL', name: 'Apple Inc.', exchange: 'XNAS', country: 'US', sector: 'Technology' },
                { symbol: 'MSFT', name: 'Microsoft Corporation', exchange: 'XNAS', country: 'US', sector: 'Technology' },
                { symbol: 'GOOGL', name: 'Alphabet Inc.', exchange: 'XNAS', country: 'US', sector: 'Technology' },
                { symbol: 'AMZN', name: 'Amazon.com Inc.', exchange: 'XNAS', country: 'US', sector: 'Consumer Discretionary' },
                { symbol: 'TSLA', name: 'Tesla Inc.', exchange: 'XNAS', country: 'US', sector: 'Consumer Discretionary' },
                { symbol: 'META', name: 'Meta Platforms Inc.', exchange: 'XNAS', country: 'US', sector: 'Technology' },
                { symbol: 'NVDA', name: 'NVIDIA Corporation', exchange: 'XNAS', country: 'US', sector: 'Technology' },
                { symbol: 'BRK.A', name: 'Berkshire Hathaway Inc.', exchange: 'XNYS', country: 'US', sector: 'Financial' },
                { symbol: 'JNJ', name: 'Johnson & Johnson', exchange: 'XNYS', country: 'US', sector: 'Healthcare' },
                { symbol: 'V', name: 'Visa Inc.', exchange: 'XNYS', country: 'US', sector: 'Financial' },
                { symbol: 'JPM', name: 'JPMorgan Chase & Co.', exchange: 'XNYS', country: 'US', sector: 'Financial' },
                { symbol: 'PG', name: 'Procter & Gamble Co.', exchange: 'XNYS', country: 'US', sector: 'Consumer Staples' },
                { symbol: 'UNH', name: 'UnitedHealth Group Inc.', exchange: 'XNYS', country: 'US', sector: 'Healthcare' },
                { symbol: 'HD', name: 'The Home Depot Inc.', exchange: 'XNYS', country: 'US', sector: 'Consumer Discretionary' },
                { symbol: 'MA', name: 'Mastercard Inc.', exchange: 'XNYS', country: 'US', sector: 'Financial' }
            ];

            // Indian Stocks (NSE & BSE)
            const indianStocks = [
                { symbol: 'RELIANCE', name: 'Reliance Industries Ltd.', exchange: 'XNSE', country: 'IN', sector: 'Energy' },
                { symbol: 'TCS', name: 'Tata Consultancy Services Ltd.', exchange: 'XNSE', country: 'IN', sector: 'Technology' },
                { symbol: 'HDFCBANK', name: 'HDFC Bank Ltd.', exchange: 'XNSE', country: 'IN', sector: 'Financial' },
                { symbol: 'INFY', name: 'Infosys Ltd.', exchange: 'XNSE', country: 'IN', sector: 'Technology' },
                { symbol: 'ICICIBANK', name: 'ICICI Bank Ltd.', exchange: 'XNSE', country: 'IN', sector: 'Financial' },
                { symbol: 'HINDUNILVR', name: 'Hindustan Unilever Ltd.', exchange: 'XNSE', country: 'IN', sector: 'Consumer Staples' },
                { symbol: 'ITC', name: 'ITC Ltd.', exchange: 'XNSE', country: 'IN', sector: 'Consumer Staples' },
                { symbol: 'SBIN', name: 'State Bank of India', exchange: 'XNSE', country: 'IN', sector: 'Financial' },
                { symbol: 'BHARTIARTL', name: 'Bharti Airtel Ltd.', exchange: 'XNSE', country: 'IN', sector: 'Telecommunications' },
                { symbol: 'AXISBANK', name: 'Axis Bank Ltd.', exchange: 'XNSE', country: 'IN', sector: 'Financial' },
                { symbol: 'ASIANPAINT', name: 'Asian Paints Ltd.', exchange: 'XNSE', country: 'IN', sector: 'Materials' },
                { symbol: 'MARUTI', name: 'Maruti Suzuki India Ltd.', exchange: 'XNSE', country: 'IN', sector: 'Consumer Discretionary' },
                { symbol: 'SUNPHARMA', name: 'Sun Pharmaceutical Industries Ltd.', exchange: 'XNSE', country: 'IN', sector: 'Healthcare' },
                { symbol: 'TATAMOTORS', name: 'Tata Motors Ltd.', exchange: 'XNSE', country: 'IN', sector: 'Consumer Discretionary' },
                { symbol: 'WIPRO', name: 'Wipro Ltd.', exchange: 'XNSE', country: 'IN', sector: 'Technology' }
            ];

            // International Stocks
            const internationalStocks = [
                { symbol: 'TSM', name: 'Taiwan Semiconductor Manufacturing Co.', exchange: 'XTAI', country: 'TW', sector: 'Technology' },
                { symbol: 'ASML', name: 'ASML Holding N.V.', exchange: 'XAMS', country: 'NL', sector: 'Technology' },
                { symbol: 'NVO', name: 'Novo Nordisk A/S', exchange: 'XCSE', country: 'DK', sector: 'Healthcare' },
                { symbol: 'SAP', name: 'SAP SE', exchange: 'XETRA', country: 'DE', sector: 'Technology' },
                { symbol: 'NESTLE', name: 'Nestle S.A.', exchange: 'XSWX', country: 'CH', sector: 'Consumer Staples' },
                { symbol: 'TCEHY', name: 'Tencent Holdings Ltd.', exchange: 'XHKG', country: 'HK', sector: 'Technology' },
                { symbol: 'BABA', name: 'Alibaba Group Holding Ltd.', exchange: 'XHKG', country: 'HK', sector: 'Consumer Discretionary' },
                { symbol: 'SHOP', name: 'Shopify Inc.', exchange: 'XTSE', country: 'CA', sector: 'Technology' },
                { symbol: 'RY', name: 'Royal Bank of Canada', exchange: 'XTSE', country: 'CA', sector: 'Financial' },
                { symbol: 'HSBC', name: 'HSBC Holdings plc', exchange: 'XLON', country: 'GB', sector: 'Financial' },
                { symbol: 'BP', name: 'BP plc', exchange: 'XLON', country: 'GB', sector: 'Energy' },
                { symbol: 'VOD', name: 'Vodafone Group plc', exchange: 'XLON', country: 'GB', sector: 'Telecommunications' },
                { symbol: 'TOYOTA', name: 'Toyota Motor Corporation', exchange: 'XTKS', country: 'JP', sector: 'Consumer Discretionary' },
                { symbol: 'SONY', name: 'Sony Group Corporation', exchange: 'XTKS', country: 'JP', sector: 'Technology' },
                { symbol: 'SAMSUNG', name: 'Samsung Electronics Co. Ltd.', exchange: 'XKRX', country: 'KR', sector: 'Technology' }
            ];

            // Add all stocks to the database
            stocks.push(...usStocks, ...indianStocks, ...internationalStocks);

            // Generate additional stocks to reach 5000+
            for (let i = 1; i <= 4970; i++) {
                const exchanges = ['XNAS', 'XNYS', 'XNSE', 'XBOM', 'XLON', 'XHKG', 'XTSE', 'XAMS', 'XETRA', 'XSWX'];
                const sectors = ['Technology', 'Financial', 'Healthcare', 'Consumer Discretionary', 'Consumer Staples', 'Energy', 'Materials', 'Industrials', 'Real Estate', 'Utilities'];
                const countries = ['US', 'IN', 'GB', 'HK', 'CA', 'NL', 'DE', 'CH', 'JP', 'KR'];
                
                const exchange = exchanges[Math.floor(Math.random() * exchanges.length)];
                const sector = sectors[Math.floor(Math.random() * sectors.length)];
                const country = countries[Math.floor(Math.random() * countries.length)];
                
                // Generate realistic stock symbols and names
                const symbol = generateStockSymbol(exchange, i);
                const name = generateCompanyName(sector, i);
                
                stocks.push({
                    symbol: symbol,
                    name: name,
                    exchange: exchange,
                    country: country,
                    sector: sector
                });
            }

            return stocks;
        }

        function generateStockSymbol(exchange, index) {
            const prefixes = {
                'XNAS': ['AAPL', 'MSFT', 'GOOG', 'AMZN', 'TSLA', 'META', 'NVDA', 'NFLX', 'ADBE', 'CRM'],
                'XNYS': ['JPM', 'JNJ', 'V', 'PG', 'UNH', 'HD', 'MA', 'DIS', 'PFE', 'BAC'],
                'XNSE': ['RELIANCE', 'TCS', 'HDFC', 'INFY', 'ICICI', 'HUL', 'ITC', 'SBIN', 'BHARTI', 'AXIS'],
                'XBOM': ['RELIANCE', 'TCS', 'HDFC', 'INFY', 'ICICI', 'HUL', 'ITC', 'SBIN', 'BHARTI', 'AXIS'],
                'XLON': ['HSBC', 'BP', 'VOD', 'GSK', 'RIO', 'BHP', 'SHEL', 'ULVR', 'PRU', 'AV'],
                'XHKG': ['TCEHY', 'BABA', '0700', '0941', '0005', '1299', '2318', '3988', '0939', '1398'],
                'XTSE': ['SHOP', 'RY', 'TD', 'CNR', 'CP', 'ENB', 'TRP', 'BCE', 'T', 'BMO']
            };

            const prefix = prefixes[exchange] || ['STOCK'];
            const basePrefix = prefix[Math.floor(Math.random() * prefix.length)];
            
            // Add random suffix for variety
            const suffixes = ['A', 'B', 'C', '1', '2', '3', 'X', 'Y', 'Z'];
            const suffix = suffixes[Math.floor(Math.random() * suffixes.length)];
            
            return basePrefix + suffix + (index % 100);
        }

        function generateCompanyName(sector, index) {
            const sectorNames = {
                'Technology': ['Tech Solutions', 'Digital Systems', 'Innovation Corp', 'Software Inc', 'Data Analytics'],
                'Financial': ['Financial Group', 'Investment Corp', 'Bank Holdings', 'Capital Partners', 'Wealth Management'],
                'Healthcare': ['Medical Systems', 'Health Solutions', 'Pharma Corp', 'Biotech Inc', 'Care Services'],
                'Consumer Discretionary': ['Retail Corp', 'Consumer Goods', 'Lifestyle Inc', 'Brand Holdings', 'Shopping Solutions'],
                'Consumer Staples': ['Food Corp', 'Beverage Inc', 'Household Products', 'Essential Goods', 'Daily Needs'],
                'Energy': ['Energy Corp', 'Power Solutions', 'Oil & Gas Inc', 'Renewable Energy', 'Utility Services'],
                'Materials': ['Materials Corp', 'Industrial Products', 'Manufacturing Inc', 'Supply Chain', 'Raw Materials'],
                'Industrials': ['Industrial Corp', 'Manufacturing Inc', 'Engineering Solutions', 'Heavy Industries', 'Construction'],
                'Real Estate': ['Property Corp', 'Real Estate Holdings', 'Development Inc', 'Land Corp', 'Housing Solutions'],
                'Utilities': ['Utility Corp', 'Power Services', 'Energy Solutions', 'Infrastructure Inc', 'Public Services']
            };

            const names = sectorNames[sector] || ['Corporation Inc'];
            const baseName = names[Math.floor(Math.random() * names.length)];
            
            return baseName + ' ' + (index % 1000);
        }

        function searchStocks() {
            const searchTerm = document.getElementById('stock-search-input').value.toLowerCase();
            const exchangeFilter = document.getElementById('exchange-filter').value;
            
            filteredStocks = allStocks.filter(stock => {
                const matchesSearch = stock.symbol.toLowerCase().includes(searchTerm) || 
                                    stock.name.toLowerCase().includes(searchTerm);
                const matchesExchange = !exchangeFilter || stock.exchange === exchangeFilter;
                
                return matchesSearch && matchesExchange;
            });
            
            updateSearchResults();
            updateSearchCount();
        }

        function filterByExchange() {
            searchStocks(); // Re-run search with exchange filter
        }

        function updateSearchResults() {
            const resultsDiv = document.getElementById('search-results');
            
            if (filteredStocks.length === 0) {
                resultsDiv.innerHTML = '<div style="text-align: center; color: #666; margin-top: 50px;">No stocks found</div>';
                return;
            }
            
            // Show first 50 results for performance
            const displayStocks = filteredStocks.slice(0, 50);
            
            let html = '<div style="font-weight: bold; padding: 4px; background: #ECE9D8; border-bottom: 1px solid #ACA899;">';
            html += '<span style="width: 80px; display: inline-block;">Symbol</span>';
            html += '<span style="width: 200px; display: inline-block;">Name</span>';
            html += '<span style="width: 80px; display: inline-block;">Exchange</span>';
            html += '<span style="width: 60px; display: inline-block;">Country</span>';
            html += '<span style="width: 100px; display: inline-block;">Sector</span>';
            html += '</div>';
            
            displayStocks.forEach(stock => {
                html += '<div class="stock-search-result" onclick="selectStock(\'' + stock.symbol + '\')" style="padding: 4px; border-bottom: 1px solid #eee; cursor: pointer;">';
                html += '<span style="width: 80px; display: inline-block; font-weight: bold; color: #0054E3;">' + stock.symbol + '</span>';
                html += '<span style="width: 200px; display: inline-block;">' + stock.name + '</span>';
                html += '<span style="width: 80px; display: inline-block;">' + stock.exchange + '</span>';
                html += '<span style="width: 60px; display: inline-block;">' + stock.country + '</span>';
                html += '<span style="width: 100px; display: inline-block;">' + stock.sector + '</span>';
                html += '</div>';
            });
            
            if (filteredStocks.length > 50) {
                html += '<div style="text-align: center; color: #666; padding: 8px; font-style: italic;">Showing first 50 of ' + filteredStocks.length + ' results</div>';
            }
            
            resultsDiv.innerHTML = html;
        }

        function updateSearchCount() {
            const countElement = document.getElementById('search-count');
            if (countElement) {
                countElement.textContent = filteredStocks.length;
            }
        }

        function selectStock(symbol) {
            // Close search window and show stock details
            closeWindow('stock-search-window');
            
            // Show loading message
            const content = document.getElementById('financial-content');
            content.innerHTML = '<div style="text-align: center; margin: 20px;"><strong>Loading details for: ' + symbol + '</strong><br><div class="loading-dots"><span></span><span></span><span></span></div></div>';
            
            // Check if it's a US stock (common symbols)
            const usStocks = ['MSFT', 'AAPL', 'GOOGL', 'AMZN', 'TSLA', 'META', 'NVDA', 'NFLX', 'ADBE', 'CRM'];
            const isUSStock = usStocks.includes(symbol.toUpperCase());
            
            if (isUSStock) {
                content.innerHTML = `
                    <div style="text-align: center; margin: 20px; padding: 16px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">
                        <h3 style="margin: 0 0 12px 0; color: #856404;">⚠️ US Stock Detected</h3>
                        <p style="margin: 0 0 12px 0; color: #856404;">
                            <strong>${symbol}</strong> is a US stock (NASDAQ/NYSE) and is not available on the Indian NSE exchange.
                        </p>
                        <div style="font-size: 12px; color: #856404; margin-bottom: 16px;">
                            <strong>Available exchanges:</strong><br>
                            • NSE (India) - Indian stocks like RELIANCE, TCS, HDFCBANK<br>
                            • BSE (India) - Indian stocks<br>
                            • For US stocks, please use a US-focused platform
                        </div>
                        <div style="text-align: center;">
                            <button onclick="loadStockData()" style="margin-right: 8px;">← Back to All Stocks</button>
                            <button onclick="openStockSearch()">🔍 Search Indian Stocks</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Fetch specific stock data from API
            fetch(`${API_BASE_URL}/api/nse/quote/${symbol}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        const stock = data.data;
                        const changeClass = stock.pChange >= 0 ? 'positive' : 'negative';
                        const changeSymbol = stock.pChange >= 0 ? '+' : '';
                        
                        content.innerHTML = `
                            <div style="margin-bottom: 16px; padding: 12px; background: #f0f0f0; border: 1px solid #ccc;">
                                <h3 style="margin: 0 0 8px 0; color: #0054E3;">${stock.name || symbol}</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                                    <div><strong>Symbol:</strong> ${stock.symbol}</div>
                                    <div><strong>Last Price:</strong> ₹${parseFloat(stock.lastPrice).toFixed(2)}</div>
                                    <div><strong>Change:</strong> <span class="stock-change ${changeClass}">${changeSymbol}₹${parseFloat(stock.change).toFixed(2)}</span></div>
                                    <div><strong>Change %:</strong> <span class="stock-change ${changeClass}">${changeSymbol}${parseFloat(stock.pChange).toFixed(2)}%</span></div>
                                    ${stock.open ? `<div><strong>Open:</strong> ₹${parseFloat(stock.open).toFixed(2)}</div>` : ''}
                                    ${stock.high ? `<div><strong>High:</strong> ₹${parseFloat(stock.high).toFixed(2)}</div>` : ''}
                                    ${stock.low ? `<div><strong>Low:</strong> ₹${parseFloat(stock.low).toFixed(2)}</div>` : ''}
                                    ${stock.volume ? `<div><strong>Volume:</strong> ${parseInt(stock.volume).toLocaleString()}</div>` : ''}
                                </div>
                                <div style="margin-top: 8px; font-size: 10px; color: #666;">
                                    Source: ${stock.source || 'NSE'} | Last Updated: ${stock.timestamp ? new Date(stock.timestamp).toLocaleString() : 'N/A'}
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 16px;">
                                <button onclick="loadStockData()" style="margin-right: 8px;">← Back to All Stocks</button>
                                <button onclick="refreshStockData('${symbol}')">🔄 Refresh</button>
                            </div>
                        `;
                    } else {
                        content.innerHTML = `
                            <div style="text-align: center; margin: 20px; padding: 16px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px;">
                                <h3 style="margin: 0 0 12px 0; color: #721c24;">❌ Stock Not Found</h3>
                                <p style="margin: 0 0 12px 0; color: #721c24;">
                                    <strong>${symbol}</strong> was not found on NSE (Indian National Stock Exchange).
                                </p>
                                <div style="font-size: 12px; color: #721c24; margin-bottom: 16px;">
                                    <strong>Try searching for:</strong><br>
                                    • RELIANCE, TCS, HDFCBANK, INFY, ICICIBANK<br>
                                    • ITC, HINDUNILVR, SBIN, BHARTIARTL<br>
                                    • Or use the exchange filter to find stocks
                                </div>
                                <div style="text-align: center;">
                                    <button onclick="loadStockData()" style="margin-right: 8px;">← Back to All Stocks</button>
                                    <button onclick="openStockSearch()">🔍 Search Again</button>
                                </div>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error fetching stock data:', error);
                    content.innerHTML = `
                        <div style="text-align: center; margin: 20px; padding: 16px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px;">
                            <h3 style="margin: 0 0 12px 0; color: #721c24;">⚠️ Connection Error</h3>
                            <p style="margin: 0 0 12px 0; color: #721c24;">
                                Unable to fetch data for <strong>${symbol}</strong> due to network issues.
                            </p>
                            <div style="font-size: 12px; color: #721c24; margin-bottom: 16px;">
                                <strong>Possible reasons:</strong><br>
                                • Network connection issue<br>
                                • API service temporarily unavailable<br>
                                • Stock symbol not available on NSE
                            </div>
                            <div style="text-align: center;">
                                <button onclick="loadStockData()" style="margin-right: 8px;">← Back to All Stocks</button>
                                <button onclick="refreshStockData('${symbol}')">🔄 Retry</button>
                            </div>
                        </div>
                    `;
                });
        }

        function clearSearch() {
            document.getElementById('stock-search-input').value = '';
            document.getElementById('exchange-filter').value = '';
            filteredStocks = [...allStocks];
            updateSearchResults();
            updateSearchCount();
        }

        function refreshStockData(symbol) {
            // Re-fetch the same stock data
            selectStock(symbol);
        }

        function openDocumentation() {
            window.open('COMPREHENSIVE_DOCUMENTATION.md', '_blank');
        }

        function openSettings() {
            alert('Settings window coming soon!');
        }

        function exitApplication() {
            if (confirm('Are you sure you want to exit?')) {
                window.close();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set current time
            function updateTime() {
                const timeElement = document.getElementById('current-time');
                if (timeElement) {
                    timeElement.textContent = new Date().toLocaleTimeString();
                }
            }
            updateTime();
            setInterval(updateTime, 1000);

            // Load initial data
            loadStockData();

            // Hide start menu when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.start-button') && !e.target.closest('#start-menu')) {
                    hideStartMenu();
                }
            });

            // Make windows draggable
            makeWindowsDraggable();
        });

        // Make windows draggable
        function makeWindowsDraggable() {
            const windows = document.querySelectorAll('.window');
            windows.forEach(window => {
                const titleBar = window.querySelector('.title-bar');
                if (titleBar) {
                    titleBar.addEventListener('mousedown', function(e) {
                        if (e.target.tagName === 'BUTTON') return; // Don't drag when clicking buttons
                        
                        const rect = window.getBoundingClientRect();
                        const offsetX = e.clientX - rect.left;
                        const offsetY = e.clientY - rect.top;
                        
                        function onMouseMove(e) {
                            window.style.left = (e.clientX - offsetX) + 'px';
                            window.style.top = (e.clientY - offsetY) + 'px';
                            window.style.position = 'absolute';
                        }
                        
                        function onMouseUp() {
                            document.removeEventListener('mousemove', onMouseMove);
                            document.removeEventListener('mouseup', onMouseUp);
                        }
                        
                        document.addEventListener('mousemove', onMouseMove);
                        document.addEventListener('mouseup', onMouseUp);
                    });
                }
            });
        }
    </script>
</body>
</html> 